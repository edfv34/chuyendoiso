<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Live Detection</title>

	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

	<style>
		body { background: linear-gradient(135deg,#f5f7fa 0%, #c3cfe2 100%); min-height:100vh; }
		.live-card { border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.08); overflow:hidden; }
		.video-wrap { background:#000; display:flex; align-items:center; justify-content:center; min-height:360px; position:relative; }
		#videoStream { width:100%; height:auto; display:block; max-height:70vh; object-fit:cover; }
		.video-placeholder { color:#999; padding:40px; text-align:center; }
		.control-bar { position:absolute; left:12px; bottom:12px; display:flex; gap:8px; z-index:5; }
		.fab { border-radius:50px; padding:10px 14px; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
		.capture-thumb { max-width:72px; height:48px; object-fit:cover; border-radius:6px; border:2px solid #fff; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
		.stats-card { border-radius:10px; padding:18px; background:linear-gradient(180deg,#ffffffcc,#ffffffaa); }
		.stat-number { font-size:1.6rem; font-weight:700; }
		.result-list img { cursor:pointer; border-radius:6px; }
		@media (max-width:767px) {
			.control-bar { bottom:8px; left:8px; }
		}
	</style>
</head>
<body>
	<div class="container py-4">
		<div class="row g-4">
			<div class="col-lg-8">
				<div class="live-card bg-white">
					<div class="p-3 border-bottom d-flex justify-content-between align-items-center">
						<h5 class="mb-0"><i class="fas fa-video me-2 text-primary"></i>Camera trực tiếp</h5>
						<small id="cameraInfo" class="text-muted">--</small>
					</div>

					<div class="video-wrap">
						<img id="videoStream" src="" style="display:none;" alt="Live stream">
						<div id="videoPlaceholder" class="video-placeholder">
							<i class="fas fa-video fa-3x mb-2"></i>
							<p class="mb-0">Nhấn "Bắt đầu" để kích hoạt camera</p>
						</div>

						<div class="control-bar">
							<button id="startBtn" class="btn btn-success fab" onclick="startCamera()"><i class="fas fa-play me-1"></i>Bắt đầu</button>
							<button id="stopBtn" class="btn btn-danger fab" onclick="stopCamera()" style="display:none;"><i class="fas fa-stop me-1"></i>Dừng</button>
							<button id="captureBtn" class="btn btn-outline-primary fab" onclick="captureFrame()" style="display:none;"><i class="fas fa-camera me-1"></i>Chụp</button>
						</div>

						<!-- thumbnail nhỏ hiển thị ảnh chụp gần nhất -->
						<div style="position:absolute; right:12px; bottom:12px;">
							<img id="lastThumb" class="capture-thumb" src="" alt="" style="display:none;">
						</div>
					</div>

					<div class="p-3">
						<div id="alertContainer"></div>
						<p class="small text-muted mb-0">Hệ thống sử dụng mô hình để phát hiện mũ bảo hộ. Có thể ở chế độ demo nếu model chưa được tải.</p>
					</div>
				</div>
			</div>

			<div class="col-lg-4">
				<div class="stats-card">
					<h6 class="mb-3"><i class="fas fa-tachometer-alt me-2 text-warning"></i>Thống kê thời gian thực</h6>
					<div class="d-flex justify-content-between align-items-center mb-2">
						<div>
							<div class="text-muted">Vi phạm</div>
							<div class="stat-number text-danger" id="liveViolations">0</div>
						</div>
						<div>
							<div class="text-muted">Tổng quét</div>
							<div class="stat-number text-primary" id="liveDetections">0</div>
						</div>
						<div>
							<div class="text-muted">Tỷ lệ</div>
							<div class="stat-number text-success" id="liveRate">0%</div>
						</div>
					</div>

					<hr>

					<h6 class="mb-2">Kết quả gần đây</h6>
					<div id="recentResults" class="result-list">
						<!-- JS sẽ chèn các mục ở đây -->
						<p class="text-muted small" id="noResultsMsg">Chưa có kết quả</p>
					</div>

					<div class="mt-3 d-grid">
						<button class="btn btn-outline-secondary" onclick="loadRecentResults()">Làm mới</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal hiển thị ảnh/chú thích -->
	<div class="modal fade" id="captureModal" tabindex="-1">
	  <div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title">Kết quả phân tích</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		  </div>
		  <div class="modal-body text-center">
			<div id="captureStats" class="mb-3"></div>
			<img id="captureImage" src="" class="img-fluid rounded">
		  </div>
		</div>
	  </div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

	<script>
		let statsInterval;
		let latestInterval;
		const captureModal = new bootstrap.Modal(document.getElementById('captureModal'));
		let lastDetectionTs = null;

		function updateCameraInfo() {
			fetch('/camera_info').then(r=>r.json()).then(d=>{
				const info = `System: ${d.system} • OpenCV ${d.opencv_version} • Camera: ${d.available_camera ?? 'N/A'}`;
				document.getElementById('cameraInfo').textContent = info;
			}).catch(()=>{});
		}

		function startCamera() {
			fetch('/start_camera').then(r=>r.json()).then(data=>{
				if (data.success) {
					document.getElementById('startBtn').style.display='none';
					document.getElementById('stopBtn').style.display='inline-block';
					document.getElementById('captureBtn').style.display='inline-block';
					const vs = document.getElementById('videoStream');
					vs.src = '/video_feed';
					vs.style.display = 'block';
					document.getElementById('videoPlaceholder').style.display='none';
					statsInterval = setInterval(loadStats, 1000);
					// start polling latest detection
					latestInterval = setInterval(pollLatestDetection, 1000);
					updateCameraInfo();
				} else { showAlert(data.message || 'Lỗi khi bật camera','danger'); }
			});
		}

		function stopCamera() {
			fetch('/stop_camera').then(r=>r.json()).then(data=>{
				if (data.success) {
					document.getElementById('startBtn').style.display='inline-block';
					document.getElementById('stopBtn').style.display='none';
					document.getElementById('captureBtn').style.display='none';
					const vs = document.getElementById('videoStream');
					vs.src = '';
					vs.style.display = 'none';
					document.getElementById('videoPlaceholder').style.display='block';
					if (statsInterval) clearInterval(statsInterval);
					if (latestInterval) { clearInterval(latestInterval); latestInterval = null; lastDetectionTs = null; }
				} else { showAlert(data.message || 'Lỗi khi dừng camera','danger'); }
			});
		}

		function loadStats() {
			fetch('/stats').then(r=>r.json()).then(d=>{
				document.getElementById('liveViolations').textContent = d.violation_count;
				document.getElementById('liveDetections').textContent = d.total_detections;
				document.getElementById('liveRate').textContent = (d.violation_rate||0).toFixed(1) + '%';
			}).catch(()=>{});
		}

		function showAlert(text, type='info') {
			const container = document.getElementById('alertContainer');
			if(!container) return;
			const el = document.createElement('div');
			el.className = `alert alert-${type} small`;
			el.innerHTML = text;
			container.prepend(el);
			setTimeout(()=>el.remove(),5000);
		}

		// Capture: lấy frame từ <img> stream bằng canvas và gửi về server
		function captureFrame() {
			const img = document.getElementById('videoStream');
			if (!img || img.style.display === 'none') { showAlert('Camera chưa hoạt động','warning'); return; }
			const canvas = document.createElement('canvas');
			canvas.width = img.naturalWidth || img.width;
			canvas.height = img.naturalHeight || img.height;
			const ctx = canvas.getContext('2d');
			ctx.drawImage(img,0,0,canvas.width,canvas.height);
			const dataURL = canvas.toDataURL('image/jpeg', 0.9);

			fetch('/capture_frame', {
				method: 'POST',
				headers: {'Content-Type':'application/json'},
				body: JSON.stringify({image: dataURL})
			})
			.then(r=>r.json())
			.then(resp=>{
				if (!resp.success) { showAlert(resp.error || 'Lỗi phân tích','danger'); return; }
				// cập nhật thumbnail và mở modal
				const thumb = document.getElementById('lastThumb');
				thumb.src = resp.result_image;
				thumb.style.display = 'block';

				document.getElementById('captureStats').innerHTML = `
					<div>Vi phạm: <strong>${resp.violation_count}</strong></div>
					<div>Tổng quét: <strong>${resp.total_detections}</strong></div>
					<div>Tỷ lệ: <strong>${(resp.violation_rate||0).toFixed(1)}%</strong></div>
				`;
				document.getElementById('captureImage').src = resp.result_image;
				captureModal.show();

				loadStats();
				loadRecentResults();
			})
			.catch(err=>{ showAlert('Lỗi gửi ảnh', 'danger'); });
		}

		// Lấy danh sách recent results và hiển thị dưới dạng thumbnails + text
		function loadRecentResults() {
			fetch('/recent_results').then(r=>r.json()).then(data=>{
				const container = document.getElementById('recentResults');
				container.innerHTML = '';
				if (!data.results || data.results.length===0) {
					document.getElementById('noResultsMsg').style.display='block';
					return;
				}
				document.getElementById('noResultsMsg').style.display='none';
				data.results.forEach(item=>{
					const row = document.createElement('div');
					row.className = 'd-flex align-items-center mb-2';
					const img = document.createElement('img');
					img.src = `/violations/${item.image}`;
					img.width = 70; img.height = 50; img.className='me-2';
					img.onclick = ()=>showImageModal(`/violations/${item.image}`);
					const txt = document.createElement('div');
					txt.innerHTML = `<div style="font-size:0.9rem">${item.timestamp}</div><div class="text-muted small">Vi phạm: ${item.violations}</div>`;
					row.appendChild(img);
					row.appendChild(txt);
					container.appendChild(row);
				});
			}).catch(()=>{});
		}

		function showImageModal(src) {
			document.getElementById('captureImage').src = src;
			document.getElementById('captureStats').innerHTML = '';
			captureModal.show();
		}

		function pollLatestDetection(){
			fetch('/latest_detection').then(r=>r.json()).then(obj=>{
				if(!obj || !obj.success) return;
				const latest = obj.latest;
				if(!latest) return;
				if(latest.timestamp === lastDetectionTs) return;
				lastDetectionTs = latest.timestamp;

				// show alert based on compliant
				if(latest.detections && latest.detections.length>0){
					if(latest.compliant){
						showAlert(`<strong>Đã đạt yêu cầu</strong> — ${latest.message}`, 'success');
					} else {
						showAlert(`<strong>YÊU CẦU ĐỘI MŨ</strong> — ${latest.violations} người không đội`, 'danger');
					}
				} else {
					// no person
					showAlert(latest.message, 'info');
				}
				// update small thumb if desired (we still rely on capture to save image)
			}).catch(()=>{});
		}

		// Khởi tạo
		document.addEventListener('DOMContentLoaded', ()=>{
			updateCameraInfo();
			loadStats();
			loadRecentResults();
		});
	</script>
</body>
</html>